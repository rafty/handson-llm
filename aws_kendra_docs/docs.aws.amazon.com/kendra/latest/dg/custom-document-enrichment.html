<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Enriching your documents during ingestion - Amazon Kendra</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="custom-document-enrichment" /><meta name="default_state" content="custom-document-enrichment" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/kendra/latest/dg/custom-document-enrichment.html" /><meta name="description" content="How to create, modify, or delete document attributes and content during the document ingestion process in Amazon Kendra." /><meta name="deployment_region" content="IAD" /><meta name="product" content="Amazon Kendra" /><meta name="guide" content="Developer Guide" /><meta name="abstract" content="Provides a conceptual overview of Amazon Kendra. Learn about Amazon Kendra features and get started indexing your documents using the console, CLI, and API." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/kendra/latest/dg/custom-document-enrichment.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/kendra/latest/dg/custom-document-enrichment.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/kendra/latest/dg/custom-document-enrichment.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/kendra/latest/dg/custom-document-enrichment.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/kendra/latest/dg/custom-document-enrichment.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/kendra/latest/dg/custom-document-enrichment.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/kendra/latest/dg/custom-document-enrichment.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/kendra/latest/dg/custom-document-enrichment.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/kendra/latest/dg/custom-document-enrichment.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/kendra/latest/dg/custom-document-enrichment.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/kendra/latest/dg/custom-document-enrichment.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/kendra/latest/dg/custom-document-enrichment.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/kendra/latest/dg/custom-document-enrichment.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/kendra/latest/dg/custom-document-enrichment.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/kendra/latest/dg/custom-document-enrichment.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/kendra/latest/dg/custom-document-enrichment.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/kendra/latest/dg/custom-document-enrichment.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/kendra/latest/dg/custom-document-enrichment.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/kendra/latest/dg/custom-document-enrichment.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/kendra/latest/dg/custom-document-enrichment.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/kendra/latest/dg/custom-document-enrichment.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/kendra/latest/dg/custom-document-enrichment.html" hreflang="x-default" /><meta name="feedback-item" content="Kendra" /><meta name="this_doc_product" content="Amazon Kendra" /><meta name="this_doc_guide" content="Developer Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'kendra'}"></script><meta id="panorama-serviceSubSection" value="Developer Guide" /><meta id="panorama-serviceConsolePage" value="Enriching your documents during ingestion" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Enriching your documents during ingestion - Amazon Kendra</title><meta name="pdf" content="/pdfs/kendra/latest/dg/kendra-dg.pdf#custom-document-enrichment" /><meta name="github" content="https://github.com/awsdocs/amazon-kendra-developer-guide/tree/master/doc_source/custom-document-enrichment.md" /><meta name="rss" content="amazon-kendra-release-notes.rss" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Kendra&amp;topic_url=http://docs.aws.amazon.com/en_us/kendra/latest/dg/custom-document-enrichment.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/kendra/latest/dg/custom-document-enrichment.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/kendra/latest/dg/custom-document-enrichment.html" /><meta name="keywords" content="Kendra,Amazon Kendra,search,intelligent search,natural language,index,question,keyword,data source,connector,FAQ,frequently asked question" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "Amazon Kendra",
        "item" : "https://docs.aws.amazon.com/kendra/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Developer Guide",
        "item" : "https://docs.aws.amazon.com/kendra/latest/dg"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Enriching your documents during ingestion",
        "item" : "https://docs.aws.amazon.com/kendra/latest/dg/custom-document-enrichment.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/kendra/latest/dg/kendra-dg.pdf#custom-document-enrichment" target="_blank" rel="noopener noreferrer" title="Open PDF"></a><a href="https://github.com/awsdocs/amazon-kendra-developer-guide/tree/master/doc_source/custom-document-enrichment.md" target="_blank" rel="noopener noreferrer" title="Edit this page on GitHub"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/kendra/index.html">Amazon Kendra</a><a href="what-is-kendra.html">Developer Guide</a></div><div id="page-toc-src"><a href="#how-custom-document-enrichment-works">How Custom Document Enrichment
                works</a><a href="#basic-data-maniplation">Basic operations to change metadata</a><a href="#advanced-data-manipulation">Lambda functions: extract and change
                metadata or content</a><a href="#cde-data-contracts-lambda">Data contracts for Lambda functions</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="custom-document-enrichment">Enriching your documents during
            ingestion</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>You can alter your content and document metadata fields or attributes during the document
        ingestion process. With Amazon Kendra's <em>Custom Document Enrichment</em>
        feature, you can create, modify, or delete document attributes and content when you ingest
        your documents into Amazon Kendra. This means you can manipulate and ingest your data
        as you need.</p><p>This feature gives you control over how your documents are treated and ingested into
            Amazon Kendra. For example, you can scrub personally identifiable information in
        the document metadata while ingesting your documents into Amazon Kendra.</p><p>Another way that you can use this feature is to invoke a Lambda function in AWS Lambda to run Optical Character Recognition (OCR) on images, translation on
        text, and other tasks for preparing the data for search or analysis. For example, you can
        invoke a function to run OCR on images. The function could interpret text from images and
        treat each image as a textual document. A company that receives mailed-in customer surveys
        and stores these surveys as images could ingest these images as textual documents into
            Amazon Kendra. The company can then search for valuable customer survey information
        in Amazon Kendra.</p><p>You can use basic operations to apply as a first parse of your data, and then use a Lambda
        function to apply more complex operations on your data. For example, you could use a basic
        operation to simply remove all values in the document metadata field 'Customer_ID', and then
        apply a Lambda function to extract text from images of the text in the documents.</p>
        <h2 id="how-custom-document-enrichment-works">How Custom Document Enrichment
                works</h2>
        <p>The overall process of Custom Document Enrichment is as follows:</p>
        <div class="orderedlist">
             
             
             
             
        <ol><li>
                <p>You configure Custom Document Enrichment when you create or update your data
                    source, or index your documents directly into Amazon Kendra.</p>
            </li><li>
                <p>Amazon Kendra applies inline configurations or basic logic to alter your
                    data. For more information, see <a href="#basic-data-maniplation">Basic operations to change metadata</a>.</p>
            </li><li>
                <p>If you choose to configure advanced data manipulation, Amazon Kendra can
                    apply this on your original, raw documents or on the structured, parsed
                    documents. For more information, see <a href="#advanced-data-manipulation">Lambda functions: extract and change
                metadata or content</a>.</p>
            </li><li>
                <p>Your altered documents are ingested into Amazon Kendra.</p>
            </li></ol></div>
        <p>At any point in this process, if your configuration is not valid, Amazon Kendra
            throws an error.</p>
        <p>When you call <a href="https://docs.aws.amazon.com/kendra/latest/APIReference/API_CreateDataSource.html">CreateDataSource</a>, <a href="https://docs.aws.amazon.com/kendra/latest/APIReference/API_UpdateDataSource.html">UpdateDataSource</a>, or <a href="https://docs.aws.amazon.com/kendra/latest/APIReference/API_BatchPutDocument.html">BatchPutDocument</a> APIs, you
            provide your Custom Document Enrichment configuration. If you call
                <code class="code">BatchPutDocument</code>, you must configure Custom Document Enrichment with
            each request. If you use the console, you select your index and then select
                <b>Document enrichments</b> to configure Custom Document
            Enrichment.</p>
        <p>If you use <b>Document enrichments</b> in the console, you can choose to
            only configure basic operations or only Lambda functions or both, like you can using the
            API. You can select <b>Next</b> in the console steps to choose not to
            configure basic operations and only Lambda functions, including whether to apply to the
            original (pre-extraction) or structured (post-extraction) data. You can only save your
            configurations by completing all the steps in the console. Your document configurations
            are not saved if you don't complete all the steps.</p>
     
        <h2 id="basic-data-maniplation">Basic operations to change metadata</h2>
        <p>You can manipulate your document fields and content using basic logic. This includes
            removing values in a field, modifying values in a field using a condition, or creating a
            field. For advanced manipulations that go beyond what you can manipulate using basic
            logic, invoke a Lambda function. For more information, see <a href="#advanced-data-manipulation">Lambda functions: extract and change
                metadata or content</a>.</p>
        <p>To apply basic logic, you specify the target field you want to manipulate using the
                <a href="https://docs.aws.amazon.com/kendra/latest/APIReference/API_DocumentAttributeTarget.html">DocumentAttributeTarget</a> object. You provide the attribute key. For example,
            the key 'Department' is a field or attribute that holds all the department names
            associated with the documents. You can also specify a value to use in the target field
            if a certain condition is met. You set the condition using the <a href="https://docs.aws.amazon.com/kendra/latest/APIReference/API_DocumentAttributeCondition.html">DocumentAttributeCondition</a> object. For example, if the 'Source_URI' field
            contains 'financial' in its URI value, then prefill the target field 'Department' with
            the target value 'Finance' for the document. You can also delete the values of the
            target document attribute.</p>
        <p>To apply basic logic using the console, select your index and then select
                <b>Document enrichments</b> in the navigation menu. Go to
                <b>Configure basic operations</b> to apply basic manipulations to your
            document fields and content.</p>
        <p>The following is an example of using basic logic to remove all customer identification
            numbers in the document field called 'Customer_ID'.</p>
        <p><b>Example 1: Removing customer identification numbers associated
                with the documents</b></p>
        <p>Data before basic manipulation applied.</p>
        <div class="table-container"><div class="table-contents"><table id="w213aac29c13c15"><thead>
                    <tr>
                        <th><b>Document_ID</b></th>
                        <th><b>Body_Text</b></th>
                        <th><b>Customer_ID</b></th>
                    </tr>
                </thead>
                    <tr>
                        <td>1</td>
                        <td>Lorem Ipsum.</td>
                        <td>CID1234</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Lorem Ipsum.</td>
                        <td>CID1235</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Lorem Ipsum.</td>
                        <td>CID1236</td>
                    </tr>
                </table></div></div>
        <p>Data after basic manipulation applied.</p>
        <div class="table-container"><div class="table-contents"><table id="w213aac29c13c19"><thead>
                    <tr>
                        <th><b>Document_ID</b></th>
                        <th><b>Body_Text</b></th>
                        <th><b>Customer_ID</b></th>
                    </tr>
                </thead>
                    <tr>
                        <td>1</td>
                        <td>Lorem Ipsum.</td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Lorem Ipsum.</td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Lorem Ipsum.</td>
                        <td> </td>
                    </tr>
                </table></div></div>
        <p>The following is an example of using basic logic to create a field called 'Department'
            and prefill this field with the department names based on information from the
            'Source_URI' field. This uses the condition that if the 'Source_URI' field contains
            'financial' in its URI value, then prefill the target field 'Department' with the target
            value 'Finance' for the document.</p>
        <p><b>Example 2: Creating 'Department' field and prefilling it with
                department names associated with the documents using a condition.</b></p>
        <p>Data before basic manipulation applied.</p>
        <div class="table-container"><div class="table-contents"><table id="w213aac29c13c27"><thead>
                    <tr>
                        <th><b>Document_ID</b></th>
                        <th><b>Body_Text</b></th>
                        <th><b>Source_URI</b></th>
                    </tr>
                </thead>
                    <tr>
                        <td>1</td>
                        <td>Lorem Ipsum.</td>
                        <td>financial/1</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Lorem Ipsum.</td>
                        <td>financial/2</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Lorem Ipsum.</td>
                        <td>financial/3</td>
                    </tr>
                </table></div></div>
        <p>Data after basic manipulation applied.</p>
        <div class="table-container"><div class="table-contents"><table id="w213aac29c13c31"><thead>
                    <tr>
                        <th><b>Document_ID</b></th>
                        <th><b>Body_Text</b></th>
                        <th><b>Source_URI</b></th>
                        <th><b>Department</b></th>
                    </tr>
                </thead>
                    <tr>
                        <td>1</td>
                        <td>Lorem Ipsum.</td>
                        <td>financial/1</td>
                        <td>Finance</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Lorem Ipsum.</td>
                        <td>financial/2</td>
                        <td>Finance</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Lorem Ipsum.</td>
                        <td>financial/3</td>
                        <td>Finance</td>
                    </tr>
                </table></div></div>
        <div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>Amazon Kendra can't create a target document field if it isn't already
                created as an index field. After you create your index field, you can create a
                document field using <code class="code">DocumentAttributeTarget</code>. Amazon Kendra then
                maps your newly created document metadata field to your index field.</p></div></div>
        <p>The following code is an example of configuring basic data manipulation to remove
            customer identification numbers associated with the documents.</p>
        <awsdocs-tabs><dl style="display: none">
            <dt>Console</dt><dd tab-id="console">
                    
                    <div class="procedure"><h6>To configure basic data manipulation to remove customer
                            identification numbers</h6><ol><li>
                            <p>In the left navigation pane, under <b>Indexes</b>,
                                select <b>Document enrichments</b> and then select
                                    <b>Add document enrichment</b>.</p>
                        </li><li>
                            <p>On the <b>Configure basic operations</b> page,
                                choose from the dropdown your data source that you want to alter
                                document fields and content. Then choose from the dropdown the
                                document field name 'Customer_ID', select from the dropdown the
                                index field name 'Customer_ID', and select from the dropdown the
                                target action <b>Delete</b>. Then select <b>Add
                                    basic operation</b>.</p>
                        </li></ol></div>
                </dd>
            <dt>CLI</dt><dd tab-id="cli">
                    <p><b>To configure basic data manipulation to remove
                            customer identification numbers</b></p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">aws kendra create-data-source \
 --name <code class="replaceable">data-source-name</code> \
 --index-id <code class="replaceable">index-id</code> \
 --role-arn <code class="replaceable">arn:aws:iam::account-id:role/role-name</code> \
 --type S3 \
 --configuration '<span>{</span>"S3Configuration":<span>{</span>"BucketName":"<code class="replaceable">S3-bucket-name</code>"}}' \
 --custom-document-enrichment-configuration '<span>{</span>"InlineConfigurations":[<span>{</span>"Target":<span>{</span>"TargetDocumentAttributeKey":"Customer_ID", "TargetDocumentAttributeValueDeletion": true}}]}' 
</code></pre>
                </dd>
            <dt>Python</dt><dd tab-id="python">
                    <p><b>To configure basic data manipulation to remove
                            customer identification numbers</b></p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">import boto3&#xD;
from botocore.exceptions import ClientError&#xD;
import pprint&#xD;
import time&#xD;
&#xD;
kendra = boto3.client("kendra")&#xD;
&#xD;
print("Create a data source with customizations")&#xD;
&#xD;
# Provide the name of the data source&#xD;
name = "data-source-name"&#xD;
# Provide the index ID for the data source&#xD;
index_id = "index-id"&#xD;
# Provide the IAM role ARN required for data sources&#xD;
role_arn = "arn:aws:iam::$<span>{</span>account-id}:role/$<span>{</span>role-name}"&#xD;
# Provide the data source connection information&#xD;
data_source_type = "S3"&#xD;
S3_bucket_name = "S3-bucket-name"&#xD;
# Configure the data source with Custom Document Enrichment&#xD;
configuration = <span>{</span>"S3Configuration":&#xD;
        <span>{</span>&#xD;
            "BucketName": S3_bucket_name&#xD;
        }&#xD;
    }&#xD;
custom_document_enrichment_configuration = <span>{</span>"InlineConfigurations":[&#xD;
        <span>{</span>&#xD;
            "Target":<span>{</span>"TargetDocumentAttributeKey":"Customer_ID",&#xD;
                       "TargetDocumentAttributeValueDeletion": True}&#xD;
        }]&#xD;
    }&#xD;
&#xD;
try:&#xD;
    data_source_response = kendra.create_data_source(&#xD;
        Name = name,&#xD;
        IndexId = index_id,&#xD;
        RoleArn = role_arn,&#xD;
        Type = data_source_type&#xD;
        Configuration = configuration&#xD;
        CustomDocumentEnrichmentConfiguration = custom_document_enrichment_configuration&#xD;
    )&#xD;
&#xD;
    pprint.pprint(data_source_response)&#xD;
&#xD;
    data_source_id = data_source_response["Id"]&#xD;
&#xD;
    print("Wait for Amazon Kendra to create the data source with your customizations.")&#xD;
&#xD;
    while True:&#xD;
        # Get the details of the data source, such as the status&#xD;
        data_source_description = kendra.describe_data_source(&#xD;
            Id = data_source_id,&#xD;
            IndexId = index_id&#xD;
        )&#xD;
        status = data_source_description["Status"]&#xD;
        print(" Creating data source. Status: "+status)&#xD;
        time.sleep(60)&#xD;
        if status != "CREATING":&#xD;
            break&#xD;
&#xD;
    print("Synchronize the data source.")&#xD;
&#xD;
    sync_response = kendra.start_data_source_sync_job(&#xD;
        Id = data_source_id,&#xD;
        IndexId = index_id&#xD;
    )&#xD;
&#xD;
    pprint.pprint(sync_response)&#xD;
&#xD;
    print("Wait for the data source to sync with the index.")&#xD;
&#xD;
    while True:&#xD;
&#xD;
        jobs = kendra.list_data_source_sync_jobs(&#xD;
            Id= data_source_id,&#xD;
            IndexId= index_id&#xD;
        )&#xD;
&#xD;
        # For this example, there should be one job&#xD;
        status = jobs["History"][0]["Status"]&#xD;
&#xD;
        print(" Syncing data source. Status: "+status)&#xD;
        time.sleep(60)&#xD;
        if status != "SYNCING":&#xD;
            break&#xD;
&#xD;
except  ClientError as e:&#xD;
        print("%s" % e)&#xD;
&#xD;
print("Program ends.")</code></pre>
                </dd>
            <dt>Java</dt><dd tab-id="java">
                    <p><b>To configure basic data manipulation to remove
                            customer identification numbers</b></p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="java ">package com.amazonaws.kendra;

import java.util.concurrent.TimeUnit;
import software.amazon.awssdk.services.kendra.KendraClient;
import software.amazon.awssdk.services.kendra.model.CreateDataSourceRequest;
import software.amazon.awssdk.services.kendra.model.CreateDataSourceResponse;
import software.amazon.awssdk.services.kendra.model.CreateIndexRequest;
import software.amazon.awssdk.services.kendra.model.CreateIndexResponse;
import software.amazon.awssdk.services.kendra.model.DataSourceConfiguration;
import software.amazon.awssdk.services.kendra.model.DataSourceStatus;
import software.amazon.awssdk.services.kendra.model.DataSourceSyncJob;
import software.amazon.awssdk.services.kendra.model.DataSourceSyncJobStatus;
import software.amazon.awssdk.services.kendra.model.DataSourceType;
import software.amazon.awssdk.services.kendra.model.DescribeDataSourceRequest;
import software.amazon.awssdk.services.kendra.model.DescribeDataSourceResponse;
import software.amazon.awssdk.services.kendra.model.DescribeIndexRequest;
import software.amazon.awssdk.services.kendra.model.DescribeIndexResponse;
import software.amazon.awssdk.services.kendra.model.IndexStatus;
import software.amazon.awssdk.services.kendra.model.ListDataSourceSyncJobsRequest;
import software.amazon.awssdk.services.kendra.model.ListDataSourceSyncJobsResponse;
import software.amazon.awssdk.services.kendra.model.S3DataSourceConfiguration;
import software.amazon.awssdk.services.kendra.model.StartDataSourceSyncJobRequest;
import software.amazon.awssdk.services.kendra.model.StartDataSourceSyncJobResponse;

public class CreateDataSourceWithCustomizationsExample <span>{</span>

    public static void main(String[] args) throws InterruptedException <span>{</span>
        System.out.println("Create a data source with customizations");
        
        String dataSourceName = "data-source-name";
        String indexId = "index-id";
        String dataSourceRoleArn = "arn:aws:iam::account-id:role/role-name";
        String s3BucketName = "S3-bucket-name"

        KendraClient kendra = KendraClient.builder().build();
        
        CreateDataSourceRequest createDataSourceRequest = CreateDataSourceRequest
            .builder()
            .name(dataSourceName)
            .description(experienceDescription)
            .roleArn(experienceRoleArn)
            .type(DataSourceType.S3)
            .configuration(
                DataSourceConfiguration
                    .builder()
                    .s3Configuration(
                        S3DataSourceConfiguration
                            .builder()
                            .bucketName(s3BucketName)
                            .build()
                    ).build()
            )
            .customDocumentEnrichmentConfiguration(
                CustomDocumentEnrichmentConfiguration
                    .builder()
                    .inlineConfigurations(Arrays.asList(
                        InlineCustomDocumentEnrichmentConfiguration
                            .builder()
                            .target(
                                DocumentAttributeTarget
                                    .builder()
                                    .targetDocumentAttributeKey("Customer_ID")
                                    .targetDocumentAttributeValueDeletion(true)
                                    .build())
                            .build()
                    )).build();
        
        CreateDataSourceResponse createDataSourceResponse = kendra.createDataSource(createDataSourceRequest);
        System.out.println(String.format("Response of creating data source: %s", createDataSourceResponse));

        String dataSourceId = createDataSourceResponse.id();
        System.out.println(String.format("Waiting for Kendra to create the data source %s", dataSourceId));
        DescribeDataSourceRequest describeDataSourceRequest = DescribeDataSourceRequest
            .builder()
            .indexId(indexId)
            .id(dataSourceId)
            .build();

        while (true) <span>{</span>
            DescribeDataSourceResponse describeDataSourceResponse = kendra.describeDataSource(describeDataSourceRequest);

            DataSourceStatus status = describeDataSourceResponse.status();
            System.out.println(String.format("Creating data source. Status: %s", status));
            TimeUnit.SECONDS.sleep(60);
            if (status != DataSourceStatus.CREATING) <span>{</span>
                break;
            }
        }

        System.out.println(String.format("Synchronize the data source %s", dataSourceId));
        StartDataSourceSyncJobRequest startDataSourceSyncJobRequest = StartDataSourceSyncJobRequest
            .builder()
            .indexId(indexId)
            .id(dataSourceId)
            .build();
        StartDataSourceSyncJobResponse startDataSourceSyncJobResponse = kendra.startDataSourceSyncJob(startDataSourceSyncJobRequest);
        System.out.println(String.format("Waiting for the data source to sync with the index %s for execution ID %s", indexId, startDataSourceSyncJobResponse.executionId()));

        // For this example, there should be one job
        ListDataSourceSyncJobsRequest listDataSourceSyncJobsRequest = ListDataSourceSyncJobsRequest
            .builder()
            .indexId(indexId)
            .id(dataSourceId)
            .build();

        while (true) <span>{</span>
            ListDataSourceSyncJobsResponse listDataSourceSyncJobsResponse = kendra.listDataSourceSyncJobs(listDataSourceSyncJobsRequest);
            DataSourceSyncJob job = listDataSourceSyncJobsResponse.history().get(0);
            System.out.println(String.format("Syncing data source. Status: %s", job.status()));

            TimeUnit.SECONDS.sleep(60);
            if (job.status() != DataSourceSyncJobStatus.SYNCING) <span>{</span>
                break;
            }

        }

        System.out.println("Data source creation with customizations is complete");
    }
}</code></pre>
                </dd>
        </dl></awsdocs-tabs>
     
        <h2 id="advanced-data-manipulation">Lambda functions: extract and change
                metadata or content</h2>
        <p>You can manipulate your document fields and content using Lambda functions. This is
            useful if you want to go beyond basic logic and apply advanced data manipulations. For
            example, using Optical Character Recognition (OCR), which interprets text from images,
            and treats each image as a textual document. Or, retrieving the current date-time in a
            certain time zone and inserting the date-time where there's an empty value for a date
            field.</p>
        <p>You can apply basic logic first and then use a Lambda function to further manipulate
            your data, or vice versa. You can also choose to only apply a Lambda function.</p>
        <p>Amazon Kendra can invoke a Lambda function to apply advanced data manipulations
            during the ingestion process as part of your <a href="https://docs.aws.amazon.com/kendra/latest/APIReference/API_CustomDocumentEnrichmentConfiguration.html">CustomDocumentEnrichmentConfiguration</a>. You specify a role that includes
            permission to execute the Lambda function and access your Amazon S3 bucket to
            store the output of your data manipulationsâ€”see <a href="https://docs.aws.amazon.com/kendra/latest/dg/iam-roles.html">IAM access
            roles</a>.</p>
        <p>Amazon Kendra can apply a Lambda function on your original, raw documents or on
            the structured, parsed documents. You can configure a Lambda function that takes your
            original or raw data and applies your data manipulations using <a href="https://docs.aws.amazon.com/kendra/latest/APIReference/API_CustomDocumentEnrichmentConfiguration.html">PreExtractionHookConfiguration</a>. You can also configure a Lambda function
            that takes your structured documents and applies your data manipulations using <a href="https://docs.aws.amazon.com/kendra/latest/APIReference/API_CustomDocumentEnrichmentConfiguration.html">PostExtractionHookConfiguration</a>. Amazon Kendra extracts the document
            metadata and text to structure your documents. Your Lambda functions must follow the
            mandatory request and response structures. For more information, see <a href="#cde-data-contracts-lambda">Data contracts for Lambda functions</a>.</p>
        <p>To configure a Lambda function in the console, select your index and then select
                <b>Document enrichments</b> in the navigation menu. Go to
                <b>Configure Lambda functions</b> to configure a Lambda
            function.</p>
        <p>You can configure only one Lambda function for
                <code class="code">PreExtractionHookConfiguration</code> and and only one Lambda function for
                <code class="code">PostExtractionHookConfiguration</code>. However, your Lambda function can
            invoke other functions that it requires. You can configure both
                <code class="code">PreExtractionHookConfiguration</code> and
                <code class="code">PostExtractionHookConfiguration</code> or either one. Your Lambda function for
                <code class="code">PreExtractionHookConfiguration</code> must not exceed a run time of 5 minutes
            and your Lambda function for <code class="code">PostExtractionHookConfiguration</code> must not
            exceed a run time of 1 minute. Configuring Custom Document Enrichment naturally takes
            longer to ingest your documents into Amazon Kendra than if you were to not
            configure this.</p>
        <p>You can configure Amazon Kendra to invoke a Lambda function only if a condition
            is met. For example, you can specify a condition that if there are empty date-time
            values, then Amazon Kendra should invoke a function that inserts the current
            date-time.</p>
        <p>The following is an example of using a Lambda function to run OCR to interpret text
            from images and store this text in a field called 'Document_Image_Text'.</p>
        <p><b>Example 1: Extracting text from images to create textual
                documents</b></p>
        <p>Data before advanced manipulation applied.</p>
        <div class="table-container"><div class="table-contents"><table id="w213aac29c15c23"><thead>
                    <tr>
                        <th><b>Document_ID</b></th>
                        <th><b>Document_Image</b></th>
                    </tr>
                </thead>
                    <tr>
                        <td>1</td>
                        <td>image_1.png</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>image_2.png</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>image_3.png</td>
                    </tr>
                </table></div></div>
        <p>Data after advanced manipulation applied.</p>
        <div class="table-container"><div class="table-contents"><table id="w213aac29c15c27"><thead>
                    <tr>
                        <th><b>Document_ID</b></th>
                        <th><b>Document_Image</b></th>
                        <th><b>Document_Image_Text</b></th>
                    </tr>
                </thead>
                    <tr>
                        <td>1</td>
                        <td>image_1.png</td>
                        <td>Mailed survey response</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>image_2.png</td>
                        <td>Mailed survey response</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>image_3.png</td>
                        <td>Mailed survey response</td>
                    </tr>
                </table></div></div>
        <p>The following is an example of using a Lambda function to insert the current date-time
            for empty date values. This uses the condition that if a date field value is 'null',
            then replace this with the current date-time.</p>
        <p><b>Example 2: Replacing empty values in the Last_Updated field with
                the current date-time.</b></p>
        <p>Data before advanced manipulation applied.</p>
        <div class="table-container"><div class="table-contents"><table id="w213aac29c15c35"><thead>
                    <tr>
                        <th><b>Document_ID</b></th>
                        <th><b>Body_Text</b></th>
                        <th><b>Last_Updated</b></th>
                    </tr>
                </thead>
                    <tr>
                        <td>1</td>
                        <td>Lorem Ipsum.</td>
                        <td>January 1, 2020</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Lorem Ipsum.</td>
                        <td> </td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Lorem Ipsum.</td>
                        <td>July 1, 2020</td>
                    </tr>
                </table></div></div>
        <p>Data after advanced manipulation applied.</p>
        <div class="table-container"><div class="table-contents"><table id="w213aac29c15c39"><thead>
                    <tr>
                        <th><b>Document_ID</b></th>
                        <th><b>Body_Text</b></th>
                        <th><b>Last_Updated</b></th>
                    </tr>
                </thead>
                    <tr>
                        <td>1</td>
                        <td>Lorem Ipsum.</td>
                        <td>January 1, 2020</td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Lorem Ipsum.</td>
                        <td>December 1, 2021</td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Lorem Ipsum.</td>
                        <td>July 1, 2020</td>
                    </tr>
                </table></div></div>
        <p>The following code is an example of configuring a Lambda function for advanced data
            manipulation on the raw, original data.</p>
        <awsdocs-tabs><dl style="display: none">
            <dt>Console</dt><dd tab-id="console">
                    
                    <div class="procedure"><h6>To configure a Lambda function for advanced data manipulation on the
                            raw, original data</h6><ol><li>
                            <p>In the left navigation pane, under <b>Indexes</b>,
                                select <b>Document enrichments</b> and then select
                                    <b>Add document enrichment</b>.</p>
                        </li><li>
                            <p>On the <b>Configure Lambda functions</b> page, in
                                the <b>Lambda for pre-extraction</b> section, select
                                from the dropdowns your Lambda function ARN and your Amazon S3 bucket. Add your IAM access role by selecting the
                                option to create a new role from the dropdown. This creates the
                                required Amazon Kendra permissions to create the document
                                enrichment.</p>
                        </li></ol></div>
                </dd>
            <dt>CLI</dt><dd tab-id="cli">
                    <p><b>To configure a Lambda function for advanced data
                            manipulation on the raw, original data</b></p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">aws kendra create-data-source \
 --name <code class="replaceable">data-source-name</code> \
 --index-id <code class="replaceable">index-id</code> \
 --role-arn <code class="replaceable">arn:aws:iam::account-id:role/role-name</code> \
 --type S3 \
 --configuration '<span>{</span>"S3Configuration":<span>{</span>"BucketName":"<code class="replaceable">S3-bucket-name</code>"}}' \
 --custom-document-enrichment-configuration '<span>{</span>"PreExtractionHookConfiguration":<span>{</span>"LambdaArn":"<code class="replaceable">arn:aws:iam::account-id:function/function-name</code>", "S3Bucket":"<code class="replaceable">S3-bucket-name</code>"}, "RoleArn": "<code class="replaceable">arn:aws:iam:account-id:role/cde-role-name</code>"}'
</code></pre>
                </dd>
            <dt>Python</dt><dd tab-id="python">
                    <p><b>To configure a Lambda function for advanced data
                            manipulation on the raw, original data</b></p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">import boto3&#xD;
from botocore.exceptions import ClientError&#xD;
import pprint&#xD;
import time&#xD;
&#xD;
kendra = boto3.client("kendra")&#xD;
&#xD;
print("Create a data source with customizations.")&#xD;
&#xD;
# Provide the name of the data source&#xD;
name = "data-source-name"&#xD;
# Provide the index ID for the data source&#xD;
index_id = "index-id"&#xD;
# Provide the IAM role ARN required for data sources&#xD;
role_arn = "arn:aws:iam::$<span>{</span>account-id}:role/$<span>{</span>role-name}"&#xD;
# Provide the data source connection information&#xD;
data_source_type = "S3"&#xD;
S3_bucket_name = "S3-bucket-name"&#xD;
# Configure the data source with Custom Document Enrichment&#xD;
configuration = <span>{</span>"S3Configuration":&#xD;
        <span>{</span>&#xD;
            "BucketName": S3_bucket_name&#xD;
        }&#xD;
    }&#xD;
custom_document_enrichment_configuration = <span>{</span>"PreExtractionHookConfiguration":&#xD;
        <span>{</span>&#xD;
            "LambdaArn":"arn:aws:iam::account-id:function/function-name",&#xD;
            "S3Bucket":"S3-bucket-name"&#xD;
        }&#xD;
    "RoleArn":"arn:aws:iam::account-id:role/cde-role-name"&#xD;
    }&#xD;
&#xD;
try:&#xD;
    data_source_response = kendra.create_data_source(&#xD;
        Name = name,&#xD;
        IndexId = index_id,&#xD;
        RoleArn = role_arn,&#xD;
        Type = data_source_type&#xD;
        Configuration = configuration&#xD;
        CustomDocumentEnrichmentConfiguration = custom_document_enrichment_configuration&#xD;
    )&#xD;
&#xD;
    pprint.pprint(data_source_response)&#xD;
&#xD;
    data_source_id = data_source_response["Id"]&#xD;
&#xD;
    print("Wait for Amazon Kendra to create the data source with your customizations.")&#xD;
&#xD;
    while True:&#xD;
        # Get the details of the data source, such as the status&#xD;
        data_source_description = kendra.describe_data_source(&#xD;
            Id = data_source_id,&#xD;
            IndexId = index_id&#xD;
        )&#xD;
        status = data_source_description["Status"]&#xD;
        print(" Creating data source. Status: "+status)&#xD;
        time.sleep(60)&#xD;
        if status != "CREATING":&#xD;
            break&#xD;
&#xD;
    print("Synchronize the data source.")&#xD;
&#xD;
    sync_response = kendra.start_data_source_sync_job(&#xD;
        Id = data_source_id,&#xD;
        IndexId = index_id&#xD;
    )&#xD;
&#xD;
    pprint.pprint(sync_response)&#xD;
&#xD;
    print("Wait for the data source to sync with the index.")&#xD;
&#xD;
    while True:&#xD;
&#xD;
        jobs = kendra.list_data_source_sync_jobs(&#xD;
            Id = data_source_id,&#xD;
            IndexId = index_id&#xD;
        )&#xD;
&#xD;
        # For this example, there should be one job&#xD;
        status = jobs["History"][0]["Status"]&#xD;
&#xD;
        print(" Syncing data source. Status: "+status)&#xD;
        time.sleep(60)&#xD;
        if status != "SYNCING":&#xD;
            break&#xD;
&#xD;
except  ClientError as e:&#xD;
        print("%s" % e)&#xD;
&#xD;
print("Program ends.")&#xD;
</code></pre>
                </dd>
            <dt>Java</dt><dd tab-id="java">
                    <p><b>To configure a Lambda function for advanced data
                            manipulation on the raw, original data</b></p>
                    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="java ">package com.amazonaws.kendra;

import java.util.concurrent.TimeUnit;
import software.amazon.awssdk.services.kendra.KendraClient;
import software.amazon.awssdk.services.kendra.model.CreateDataSourceRequest;
import software.amazon.awssdk.services.kendra.model.CreateDataSourceResponse;
import software.amazon.awssdk.services.kendra.model.CreateIndexRequest;
import software.amazon.awssdk.services.kendra.model.CreateIndexResponse;
import software.amazon.awssdk.services.kendra.model.DataSourceConfiguration;
import software.amazon.awssdk.services.kendra.model.DataSourceStatus;
import software.amazon.awssdk.services.kendra.model.DataSourceSyncJob;
import software.amazon.awssdk.services.kendra.model.DataSourceSyncJobStatus;
import software.amazon.awssdk.services.kendra.model.DataSourceType;
import software.amazon.awssdk.services.kendra.model.DescribeDataSourceRequest;
import software.amazon.awssdk.services.kendra.model.DescribeDataSourceResponse;
import software.amazon.awssdk.services.kendra.model.DescribeIndexRequest;
import software.amazon.awssdk.services.kendra.model.DescribeIndexResponse;
import software.amazon.awssdk.services.kendra.model.IndexStatus;
import software.amazon.awssdk.services.kendra.model.ListDataSourceSyncJobsRequest;
import software.amazon.awssdk.services.kendra.model.ListDataSourceSyncJobsResponse;
import software.amazon.awssdk.services.kendra.model.S3DataSourceConfiguration;
import software.amazon.awssdk.services.kendra.model.StartDataSourceSyncJobRequest;
import software.amazon.awssdk.services.kendra.model.StartDataSourceSyncJobResponse;


public class CreateDataSourceWithCustomizationsExample <span>{</span>

    public static void main(String[] args) throws InterruptedException <span>{</span>
        System.out.println("Create a data source with customizations");
        
        String dataSourceName = "data-source-name";
        String indexId = "index-id";
        String dataSourceRoleArn = "arn:aws:iam::account-id:role/role-name";
        String s3BucketName = "S3-bucket-name"

        KendraClient kendra = KendraClient.builder().build();
        
        CreateDataSourceRequest createDataSourceRequest = CreateDataSourceRequest
            .builder()
            .name(dataSourceName)
            .description(experienceDescription)
            .roleArn(experienceRoleArn)
            .type(DataSourceType.S3)
            .configuration(
                DataSourceConfiguration
                    .builder()
                    .s3Configuration(
                        S3DataSourceConfiguration
                            .builder()
                            .bucketName(s3BucketName)
                            .build()
                    ).build()
            )
            .customDocumentEnrichmentConfiguration(
                CustomDocumentEnrichmentConfiguration
                    .builder()
                    .preExtractionHookConfiguration(
                        HookConfiguration
                            .builder()
                            .lambdaArn("arn:aws:iam::account-id:function/function-name")
                            .s3Bucket("S3-bucket-name")
                            .build())
                    .roleArn("arn:aws:iam::account-id:role/cde-role-name")
                    .build();
        
        CreateDataSourceResponse createDataSourceResponse = kendra.createDataSource(createDataSourceRequest);
        System.out.println(String.format("Response of creating data source: %s", createDataSourceResponse));

        String dataSourceId = createDataSourceResponse.id();
        System.out.println(String.format("Waiting for Kendra to create the data source %s", dataSourceId));
        DescribeDataSourceRequest describeDataSourceRequest = DescribeDataSourceRequest
            .builder()
            .indexId(indexId)
            .id(dataSourceId)
            .build();

        while (true) <span>{</span>
            DescribeDataSourceResponse describeDataSourceResponse = kendra.describeDataSource(describeDataSourceRequest);

            DataSourceStatus status = describeDataSourceResponse.status();
            System.out.println(String.format("Creating data source. Status: %s", status));
            TimeUnit.SECONDS.sleep(60);
            if (status != DataSourceStatus.CREATING) <span>{</span>
                break;
            }
        }

        System.out.println(String.format("Synchronize the data source %s", dataSourceId));
        StartDataSourceSyncJobRequest startDataSourceSyncJobRequest = StartDataSourceSyncJobRequest
            .builder()
            .indexId(indexId)
            .id(dataSourceId)
            .build();
        StartDataSourceSyncJobResponse startDataSourceSyncJobResponse = kendra.startDataSourceSyncJob(startDataSourceSyncJobRequest);
        System.out.println(String.format("Waiting for the data source to sync with the index %s for execution ID %s", indexId, startDataSourceSyncJobResponse.executionId()));

        // For this example, there should be one job
        ListDataSourceSyncJobsRequest listDataSourceSyncJobsRequest = ListDataSourceSyncJobsRequest
            .builder()
            .indexId(indexId)
            .id(dataSourceId)
            .build();

        while (true) <span>{</span>
            ListDataSourceSyncJobsResponse listDataSourceSyncJobsResponse = kendra.listDataSourceSyncJobs(listDataSourceSyncJobsRequest);
            DataSourceSyncJob job = listDataSourceSyncJobsResponse.history().get(0);
            System.out.println(String.format("Syncing data source. Status: %s", job.status()));

            TimeUnit.SECONDS.sleep(60);
            if (job.status() != DataSourceSyncJobStatus.SYNCING) <span>{</span>
                break;
            }

        }

        System.out.println("Data source creation with customizations is complete");
    }
}</code></pre>
                </dd>
        </dl></awsdocs-tabs>
     
        <h2 id="cde-data-contracts-lambda">Data contracts for Lambda functions</h2>
        <p>Your Lambda functions for advanced data manipulation interact with Amazon Kendra
            data contracts. The contracts are the mandatory request and response structures of your
            Lambda functions. If your Lambda functions don't follow these structures, then Amazon Kendra throws an error.</p>
        <p>Your Lambda function for <code class="code">PreExtractionHookConfiguration</code> should expect the
            following request structure:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "version": &lt;str&gt;,
    "dataBlobStringEncodedInBase64": &lt;str&gt;, //In the case of a data blob
    "s3Bucket": &lt;str&gt;, //In the case of an S3 bucket
    "s3ObjectKey": &lt;str&gt;, //In the case of an S3 bucket
    "metadata": &lt;Metadata&gt;
}</code></pre>
        <p>The <code class="code">metadata</code> structure, which includes the
                <code class="code">CustomDocumentAttribute</code> structure, is as follows:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json "><span>{</span>
    "attributes": [&lt;CustomDocumentAttribute&lt;]
}

CustomDocumentAttribute
<span>{</span>
    "name": &lt;str&gt;,
    "value": &lt;CustomDocumentAttributeValue&gt;
}

CustomDocumentAttributeValue
<span>{</span>
    "stringValue": &lt;str&gt;,
    "integerValue": &lt;int&gt;,
    "longValue": &lt;long&gt;,
    "stringListValue": list&lt;str&gt;,
    "dateValue": &lt;str&gt;
}</code></pre>
        <p>Your Lambda function for <code class="code">PreExtractionHookConfiguration</code> must adhere to
            the following response structure:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
    "version": &lt;str&gt;,
    "dataBlobStringEncodedInBase64": &lt;str&gt;, //In the case of a data blob
    "s3ObjectKey": &lt;str&gt;, //In the case of an S3 bucket
    "metadataUpdates": [&lt;CustomDocumentAttribute&gt;]
}</code></pre>
        <p>Your Lambda function for <code class="code">PostExtractionHookConfiguration</code> should expect
            the following request structure:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class=""><span>{</span>
    "version": &lt;str&gt;,
    "s3Bucket": &lt;str&gt;,
    "s3ObjectKey": &lt;str&gt;,
    "metadata": &lt;Metadata&gt;
}</code></pre>
        <p>Your Lambda function for <code class="code">PostExtractionHookConfiguration</code> must adhere to
            the following response structure:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">PostExtractionHookConfiguration Lambda Response
<span>{</span>
    "version": &lt;str&gt;,
    "s3ObjectKey": &lt;str&gt;,
    "metadataUpdates": [&lt;CustomDocumentAttribute&gt;]
}</code></pre>
        <p>Your altered document is uploaded to your Amazon S3 bucket. The altered
            document must follow the format shown in <a href="#structured-document-format">Structured document format</a>.</p>
         
            <h3 id="structured-document-format">Structured document format</h3>
            <p>Amazon Kendra uploads your structured document to the given Amazon S3
                bucket. The structured document follows this format:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="json ">Kendra document

<span>{</span>
   "textContent": &lt;TextContent&gt;
}

TextContent
<span>{</span>
  "documentBodyText": &lt;str&gt;
}</code></pre>
         
         
            <h3 id="example-lambda-function-advanced-manipulation">Example of a Lambda
                    function that adheres to data contracts</h3>
            <p>The following Python code is an example of a Lambda function that applies advanced
                manipulation of the metadata fields <code class="code">_authors</code>,
                    <code class="code">_document_title</code>, and the body content on the raw or original
                documents.</p>
            <p><b>In the case of the body content residing in an Amazon S3 bucket</b></p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">import json&#xD;
import boto3&#xD;
     &#xD;
s3 = boto3.client("s3")&#xD;
&#xD;
# Lambda function for advanced data manipulation    &#xD;
def lambda_handler(event, context):&#xD;
    # Get the value of "S3Bucket" key name or item from the given event input&#xD;
    s3_bucket = event.get("s3Bucket")&#xD;
    # Get the value of "S3ObjectKey" key name or item from the given event input&#xD;
    s3_object_key = event.get("s3ObjectKey")&#xD;
    &#xD;
    content_object_before_CDE = s3.get_object(Bucket = s3_bucket, Key = s3_object_key)&#xD;
    content_before_CDE = content_object_before_CDE["Body"].read().decode("utf-8");&#xD;
    content_after_CDE = "CDEInvolved " + content_before_CDE&#xD;
    &#xD;
    # Get the value of "metadata" key name or item from the given event input&#xD;
    metadata = event.get("metadata")&#xD;
    # Get the document "attributes" from the metadata &#xD;
    document_attributes = metadata.get("attributes")&#xD;
    &#xD;
    s3.put_object(Bucket = s3_bucket, Key = "dummy_updated_kendra_document", Body=json.dumps(content_after_CDE))&#xD;
    return <span>{</span>&#xD;
        "version": "v0",&#xD;
        "s3ObjectKey": "dummy_updated_kendra_document",&#xD;
        "metadataUpdates": [&#xD;
            <span>{</span>"name":"_document_title", "value":<span>{</span>"stringValue":"title_from_pre_extraction_lambda"}},&#xD;
            <span>{</span>"name":"_authors", "value":<span>{</span>"stringListValue":["author1", "author2"]}}&#xD;
        ]&#xD;
    }</code></pre>
            <p><b>In the case of the body content residing in a data
                    blob</b></p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">import json&#xD;
import boto3&#xD;
import base64&#xD;
&#xD;
# Lambda function for advanced data manipulation&#xD;
def lambda_handler(event, context):&#xD;
    &#xD;
    # Get the value of "dataBlobStringEncodedInBase64" key name or item from the given event input &#xD;
    data_blob_string_encoded_in_base64 = event.get("dataBlobStringEncodedInBase64")&#xD;
    # Decode the data blob string in UTF-8&#xD;
    data_blob_string = base64.b64decode(data_blob_string_encoded_in_base64).decode("utf-8")&#xD;
    # Get the value of "metadata" key name or item from the given event input    &#xD;
    metadata = event.get("metadata")&#xD;
    # Get the document "attributes" from the metadata&#xD;
    document_attributes = metadata.get("attributes")&#xD;
    &#xD;
    new_data_blob = "This should be the modified data in the document by pre processing lambda ".encode("utf-8")&#xD;
    return <span>{</span>&#xD;
        "version": "v0",&#xD;
        "dataBlobStringEncodedInBase64": base64.b64encode(new_data_blob).decode("utf-8"),&#xD;
        "metadataUpdates": [&#xD;
            <span>{</span>"name":"_document_title", "value":<span>{</span>"stringValue":"title_from_pre_extraction_lambda"}},&#xD;
            <span>{</span>"name":"_authors", "value":<span>{</span>"stringListValue":["author1", "author2"]}}&#xD;
        ]&#xD;
    }</code></pre>
            <p>The following Python code is an example of a Lambda function that applies advanced
                manipulation of the metadata fields <code class="code">_authors</code>,
                    <code class="code">_document_title</code>, and the body content on the structured or parsed
                documents.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="python ">import json&#xD;
import boto3&#xD;
import time&#xD;
&#xD;
s3 = boto3.client("s3")&#xD;
&#xD;
# Lambda function for advanced data manipulation&#xD;
def lambda_handler(event, context):&#xD;
    &#xD;
    # Get the value of "S3Bucket" key name or item from the given event input&#xD;
    s3_bucket = event.get("s3Bucket")&#xD;
    # Get the value of "S3ObjectKey" key name or item from the given event input&#xD;
    s3_key = event.get("s3ObjectKey")&#xD;
    # Get the value of "metadata" key name or item from the given event input&#xD;
    metadata = event.get("metadata")&#xD;
    # Get the document "attributes" from the metadata &#xD;
    document_attributes = metadata.get("attributes")&#xD;
    &#xD;
    kendra_document_object = s3.get_object(Bucket = s3_bucket, Key = s3_key)&#xD;
    kendra_document_string = kendra_document_object['Body'].read().decode('utf-8')&#xD;
    kendra_document = json.loads(kendra_document_string)&#xD;
    kendra_document["textContent"]["documentBodyText"] = "Changing document body to a short sentence."&#xD;
    &#xD;
    s3.put_object(Bucket = s3_bucket, Key = "dummy_updated_kendra_document", Body=json.dumps(kendra_document))&#xD;
&#xD;
    return <span>{</span>&#xD;
        "version" : "v0",&#xD;
        "s3ObjectKey": "dummy_updated_kendra_document",&#xD;
        "metadataUpdates": [&#xD;
            <span>{</span>"name": "_document_title", "value":<span>{</span>"stringValue": "title_from_post_extraction_lambda"}},&#xD;
            <span>{</span>"name": "_authors", "value":<span>{</span>"stringListValue":["author1", "author2"]}}&#xD;
        ]&#xD;
    }</code></pre>
         
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./delete-data-source.html">Deleting data sources</div><div id="next" class="next-link" accesskey="n" href="./searching.html">Searching indexes</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Kendra&amp;topic_url=https://docs.aws.amazon.com/en_us/kendra/latest/dg/custom-document-enrichment.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=Kendra&amp;topic_url=https://docs.aws.amazon.com/en_us/kendra/latest/dg/custom-document-enrichment.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>