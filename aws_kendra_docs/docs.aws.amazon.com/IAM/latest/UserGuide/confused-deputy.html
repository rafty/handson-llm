<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>The confused deputy problem - AWS Identity and Access Management</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="confused-deputy" /><meta name="default_state" content="confused-deputy" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html" /><meta name="description" content="The confused deputy problem is a security issue where an entity that doesn't have permission to perform an action can coerce a more-privileged entity to perform the action. To prevent this, AWS provides tools that help you protect your account if you provide third parties (known as" /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS Identity and Access Management" /><meta name="guide" content="User Guide" /><meta name="abstract" content="Control access to your AWS resources with user identity (authentication) and with policies that define specific permissions (authorization)." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/IAM/latest/UserGuide/confused-deputy.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/IAM/latest/UserGuide/confused-deputy.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/IAM/latest/UserGuide/confused-deputy.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/IAM/latest/UserGuide/confused-deputy.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/IAM/latest/UserGuide/confused-deputy.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/IAM/latest/UserGuide/confused-deputy.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/IAM/latest/UserGuide/confused-deputy.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/IAM/latest/UserGuide/confused-deputy.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/IAM/latest/UserGuide/confused-deputy.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/IAM/latest/UserGuide/confused-deputy.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/confused-deputy.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/IAM/latest/UserGuide/confused-deputy.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/confused-deputy.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/confused-deputy.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/IAM/latest/UserGuide/confused-deputy.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/IAM/latest/UserGuide/confused-deputy.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/confused-deputy.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/IAM/latest/UserGuide/confused-deputy.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html" hreflang="x-default" /><meta name="feedback-item" content="IAM" /><meta name="this_doc_product" content="AWS Identity and Access Management" /><meta name="this_doc_guide" content="User Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'iam'}"></script><meta id="panorama-serviceSubSection" value="User Guide" /><meta id="panorama-serviceConsolePage" value="The confused deputy problem" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>The confused deputy problem - AWS Identity and Access Management</title><meta name="pdf" content="/pdfs/IAM/latest/UserGuide/iam-ug.pdf#confused-deputy" /><meta name="github" content="https://github.com/awsdocs/iam-user-guide/tree/main/doc_source/confused-deputy.md" /><meta name="rss" content="aws-iam-release-notes.rss" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=76" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IAM&amp;topic_url=http://docs.aws.amazon.com/en_us/IAM/latest/UserGuide/confused-deputy.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/IAM/latest/UserGuide/confused-deputy.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/IAM/latest/UserGuide/confused-deputy.html" /><meta name="keywords" content="IAM,AWS Identity and Access Management,IAM user,user,IAM group,group,IAM role,role,permission policy,trust policy,policy,access key,password" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS Identity and Access Management",
        "item" : "https://docs.aws.amazon.com/iam/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "User Guide",
        "item" : "https://docs.aws.amazon.com/IAM/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "IAM Identities (users, user groups, and roles)",
        "item" : "https://docs.aws.amazon.com/IAM/latest/UserGuide/id.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "IAM roles",
        "item" : "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Common scenarios for roles: Users, applications, and services",
        "item" : "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "The confused deputy problem",
        "item" : "https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_common-scenarios.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/IAM/latest/UserGuide/iam-ug.pdf#confused-deputy" target="_blank" rel="noopener noreferrer" title="Open PDF"></a><a href="https://github.com/awsdocs/iam-user-guide/tree/main/doc_source/confused-deputy.md" target="_blank" rel="noopener noreferrer" title="Edit this page on GitHub"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/iam/index.html">AWS Identity and Access Management</a><a href="introduction.html">User Guide</a></div><div id="page-toc-src"><a href="#mitigate-confused-deputy">Cross-account confused deputy
                prevention</a><a href="#cross-service-confused-deputy-prevention">Cross-service confused deputy
                prevention</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="confused-deputy">The confused deputy problem</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>The confused deputy problem is a security issue where an entity that doesn't have
        permission to perform an action can coerce a more-privileged entity to perform the action.
        To prevent this, AWS provides tools that help you protect your account if you provide
        third parties (known as <em>cross-account</em>) or other AWS services (known
        as <em>cross-service</em>) access to resources in your account.</p><p>At times, you might need to give a third party access to your AWS resources (delegate
        access). For example, let's say that you decide to hire a third-party company called Example
        Corp to monitor your AWS account and help optimize costs. In order to track your daily
        spending, Example Corp needs to access your AWS resources. Example Corp also monitors many
        other AWS accounts for other customers. You can use an IAM role to establish a trusted
        relationship between your AWS account and the Example Corp account. One important aspect
        of this scenario is the <em>external ID</em>, optional information that you can
        use in an IAM role trust policy to designate who can assume the role. The primary function
        of the external ID is to address and prevent the confused deputy problem.</p><p>In AWS, cross-service impersonation can result in the confused deputy problem.
        Cross-service impersonation can occur when one service (the <em>calling
            service</em>) calls another service (the <em>called service</em>). The
        calling service can be manipulated to use its permissions to act on another customer's
        resources in a way it should not otherwise have permission to access.</p>
        <h2 id="mitigate-confused-deputy">Cross-account confused deputy
                prevention</h2>
        <p>The following diagram illustrates the cross-account confused deputy problem.</p>
        <div class="mediaobject">
             
                <img src="/images/IAM/latest/UserGuide/images/confuseddeputyproblem2.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                The description of a confused deputy problem.&#xA;            " />
             
             
                
             
             
                
             
             
        </div>
        <p>This scenario assumes the following:</p>
        <div class="itemizedlist">
             
             
        <ul class="itemizedlist"><li class="listitem">
                <p><b>AWS1</b> is your AWS account.</p>
            </li><li class="listitem">
                <p><b>AWS1:ExampleRole</b> is a role in your account.
                    This role's trust policy trusts Example Corp by specifying Example Corp's AWS
                    account as the one that can assume the role.</p>
            </li></ul></div>
        <p>Here's what happens:</p>
        <div class="orderedlist">
             
             
             
             
        <ol><li>
                <p>When you start using Example Corp's service, you provide the ARN of <b>AWS1:ExampleRole</b> to Example Corp.</p>
            </li><li>
                <p>Example Corp uses that role ARN to obtain temporary security credentials to
                    access resources in your AWS account. In this way, you are trusting Example
                    Corp as a "deputy" that can act on your behalf.</p>
            </li><li>
                <p>Another AWS customer also starts using Example Corp's service, and this
                    customer also provides the ARN of <b>AWS1:ExampleRole</b> for Example Corp to use. Presumably the other
                    customer learned or guessed the <b>AWS1:ExampleRole</b>, which isn't a secret.</p>
            </li><li>
                <p>When the other customer asks Example Corp to access AWS resources in (what
                    it claims to be) its account, Example Corp uses <b>AWS1:ExampleRole</b> to access resources in your account.</p>
            </li></ol></div>
        <p>This is how the other customer could gain unauthorized access to your resources.
            Because this other customer was able to trick Example Corp into unwittingly acting on
            your resources, Example Corp is now a "confused deputy."</p>
        <p>Example Corp can address the confused deputy problem by requiring that you include the
                <code class="code">ExternalId</code> condition check in the role's trust policy. Example Corp
            generates a unique <code class="code">ExternalId</code> value for each customer and uses that value
            in its request to assume the role. The <code class="code">ExternalId</code> value must be unique
            among Example Corp's customers and controlled by Example Corp, not its customers. This
            is why you get it from Example Corp and you don't come up with it on your own. This
            prevents Example Corp from being a confused deputy and granting access to another
            account's AWS resources.</p>
        <p>In our scenario, imagine Example Corp's unique identifier for you is 12345, and its
            identifier for the other customer is 67890. These identifiers are simplified for this
            scenario. Generally, these identifiers are GUIDs. Assuming that these identifiers are
            unique among Example Corp's customers, they are sensible values to use for the external
            ID. </p>
        <p>Example Corp gives the external ID value of 12345 to you. You must then add a
                <code class="code">Condition</code> element to the role's trust policy that requires the
                <code class="code">sts:ExternalId</code> value to be 12345, like this:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="JSON "><span>{</span>
  "Version": "2012-10-17",
  "Statement": <span>{</span>
    "Effect": "Allow",
    "Principal": <span>{</span>
      "AWS": "<code class="replaceable">Example Corp's AWS Account ID</code>"
    },
    "Action": "sts:AssumeRole",
    "Condition": <span>{</span>
      "StringEquals": <span>{</span>
        "sts:ExternalId": "12345"
      }
    }
  }
}
</code></pre>
        <p>The Condition element in this policy allows Example Corp to assume the role only when
            the AssumeRole API call includes the external ID value of 12345. Example Corp makes sure
            that whenever it assumes a role on behalf of a customer, it always includes that
            customer's external ID value in the AssumeRole call. Even if another customer supplies
            Example Corp with your ARN, it cannot control the external ID that Example Corp includes
            in its request to AWS. This helps prevent an unauthorized customer from gaining access
            to your resources.</p>
        <p>The following diagram illustrates this.</p>
        <div class="mediaobject">
             
                <img src="/images/IAM/latest/UserGuide/images/confuseddeputymitigation2.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="&#xA;                How to mitigate a confused deputy problem.&#xA;            " />
             
             
                
             
             
                
             
             
        </div>
        <div class="orderedlist">
             
             
             
             
        <ol><li>
                <p>As before, when you start using Example Corp's service, you provide the ARN of
                        <b>AWS1:ExampleRole</b> to Example Corp.</p>
            </li><li>
                <p> When Example Corp uses that role ARN to assume the role <b>AWS1:ExampleRole</b>, Example Corp includes your external ID
                    (12345) in the AssumeRole API call. The external ID matches the role's trust
                    policy, so the AssumeRole API call succeeds and Example Corp obtains temporary
                    security credentials to access resources in your AWS account.</p>
            </li><li>
                <p>Another AWS customer also starts using Example Corp's service, and as
                    before, this customer also provides the ARN of <b>AWS1:ExampleRole</b> for Example Corp to use. </p>
            </li><li>
                <p>But this time, when Example Corp attempts to assume the role <b>AWS1:ExampleRole</b>, it provides the external ID
                    associated with the other customer (67890). The other customer has no way to
                    change this. Example Corp does this because the request to use the role came
                    from the other customer, so 67890 indicates the circumstance in which Example
                    Corp is acting. Because you added a condition with your own external ID (12345)
                    to the trust policy of <b>AWS1:ExampleRole</b>, the
                    AssumeRole API call fails. The other customer is prevented from gaining
                    unauthorized access to resources in your account (indicated by the red "X" in
                    the diagram).</p>
            </li></ol></div>
        <p>The external ID helps prevent any other customer from tricking Example Corp into
            unwittingly accessing your resources.</p>
     
        <h2 id="cross-service-confused-deputy-prevention">Cross-service confused deputy
                prevention</h2>
        <p>We recommend using the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn"><code class="code">aws:SourceArn</code></a> and <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourceaccount"><code class="code">aws:SourceAccount</code></a> global condition context keys in
            resource-based policies to limit the permissions that a service has to a specific
            resource. Use <code class="code">aws:SourceArn</code> if you want only one resource to be associated
            with the cross-service access. Use <code class="code">aws:SourceAccount</code> if you want to allow
            any resource in that account to be associated with the cross-service use.</p>
        <p>The most effective way to protect against the confused deputy problem is to use the
                <code class="code">aws:SourceArn</code> global condition context key with the full ARN of the
            resource in your resource-based policies. If you don't know the full ARN of the resource
            or if you are specifying multiple resources, use the <code class="code">aws:SourceArn</code> global
            condition context key with wildcards (<code class="code">*</code>) for the unknown portions of the
            ARN. For example,
                    <code class="code">arn:aws:<code class="replaceable">servicename</code>:*:<code class="replaceable">123456789012</code>:*</code>.</p>
        <p>If the <code class="code">aws:SourceArn</code> value does not contain the account ID, such as an
            Amazon S3 bucket ARN, you must use both global condition context keys to limit
            permissions.</p>

         
            <h3 id="cross-service-confused-deputy-prevention-sts">Cross-service
                    confused deputy prevention for AWS Security Token Service</h3>
            <p>Many AWS services require that you use roles to allow the service to access
                another service's resources on your behalf. A role that a service assumes to perform
                actions on your behalf is called a <a href="./id_roles_terms-and-concepts.html#iam-term-service-role">service
                    role</a>. A role requires two policies: a role trust policy that specifies
                the principal that is allowed to assume the role and a permissions policy that
                specifies what can be done with the role. A role trust policy is the only type of
                resource-based policy in IAM. Other AWS services have resource-based policies,
                such as an Amazon S3 bucket policy.</p>
            <p>When a service assumes a role on your behalf, the service principal must be
                allowed to perform the <code class="code">sts:AssumeRole</code> action in the role trust policy.
                When a service calls <code class="code">sts:AssumeRole</code>, AWS STS returns a set of temporary
                security credentials that the service principal uses to access the resources that
                are permitted by the roleâ€™s permissions policy. When a service assumes a role in
                your account, you can include the <code class="code">aws:SourceAccount</code> and
                    <code class="code">aws:SourceArn</code> global condition context keys in your role trust
                policy to limit access to the role to only requests that are generated by expected
                resources.</p>
            <p>For example, in AWS Systems Manager Incident Manager, you must choose a role to allow Incident Manager
                to run a Systems Manager automation document on your behalf. The automation document can
                include automated response plans for incidents that are initiated by CloudWatch alarms or
                EventBridge events. In the following role trust policy example, you can use the
                    <code class="code">aws:SourceArn</code> condition key to restrict access to the service role
                based on the incident record's ARN. Only incident records that are created from the
                response plan resource <code class="code">myresponseplan</code> are able to use this role.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="JSON "><span>{</span>
  "Version": "2012-10-17",
  "Statement": <span>{</span>
    "Effect": "Allow",
    "Principal": <span>{</span>
      "Service": "ssm-incidents.amazonaws.com"
    },
    "Action": "sts:AssumeRole",
    "Condition": <span>{</span>
      "ArnLike": <span>{</span>
        "aws:SourceArn": "arn:aws:ssm-incidents:*:<code class="replaceable">111122223333</code>:incident-record/<code class="replaceable">myresponseplan</code>/*"
      }
    }
  }
}</code></pre>
         
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./id_roles_common-scenarios_services.html">Providing access to AWS services</div><div id="next" class="next-link" accesskey="n" href="./id_roles_common-scenarios_federated-users.html">Providing access through identity federation</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IAM&amp;topic_url=https://docs.aws.amazon.com/en_us/IAM/latest/UserGuide/confused-deputy.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=IAM&amp;topic_url=https://docs.aws.amazon.com/en_us/IAM/latest/UserGuide/confused-deputy.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>