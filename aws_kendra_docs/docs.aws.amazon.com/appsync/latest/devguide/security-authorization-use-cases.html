<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Authorization use cases - AWS AppSync</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="security-authorization-use-cases" /><meta name="default_state" content="security-authorization-use-cases" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/appsync/latest/devguide/security-authorization-use-cases.html" /><meta name="description" content="Authorization scenarios for AWS AppSync." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS AppSync" /><meta name="guide" content="Developer Guide" /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/appsync/latest/devguide/security-authorization-use-cases.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/appsync/latest/devguide/security-authorization-use-cases.html" hreflang="x-default" /><meta name="feedback-item" content="AppSync" /><meta name="this_doc_product" content="AWS AppSync" /><meta name="this_doc_guide" content="Developer Guide" /><script defer="" src="/assets/r/vendor4.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor3.js?version=2021.12.02"></script><script defer="" src="/assets/r/vendor1.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-common.js?version=2021.12.02"></script><script defer="" src="/assets/r/awsdocs-doc-page.js?version=2021.12.02"></script><link href="/assets/r/vendor4.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-common.css?version=2021.12.02" rel="stylesheet" /><link href="/assets/r/awsdocs-doc-page.css?version=2021.12.02" rel="stylesheet" /><script async="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'appsync'}"></script><meta id="panorama-serviceSubSection" value="Developer Guide" /><meta id="panorama-serviceConsolePage" value="Authorization use cases" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Authorization use cases - AWS AppSync</title><meta name="pdf" content="/pdfs/appsync/latest/devguide/appsync-dg.pdf#security-authorization-use-cases" /><meta name="forums" content="http://forums.aws.amazon.com/forum.jspa?forumID=280" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=AppSync&amp;topic_url=http://docs.aws.amazon.com/en_us/appsync/latest/devguide/security-authorization-use-cases.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=http://docs.aws.amazon.com/en_us/appsync/latest/devguide/security-authorization-use-cases.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=http://docs.aws.amazon.com/en_us/appsync/latest/devguide/security-authorization-use-cases.html" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS AppSync",
        "item" : "https://docs.aws.amazon.com/appsync/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "Developer Guide",
        "item" : "https://docs.aws.amazon.com/appsync/latest/devguide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Authorization and authentication",
        "item" : "https://docs.aws.amazon.com/appsync/latest/devguide/security-authz.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Authorization use cases",
        "item" : "https://docs.aws.amazon.com/appsync/latest/devguide/security-authz.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/appsync/latest/devguide/appsync-dg.pdf#security-authorization-use-cases" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="https://aws.amazon.com">AWS</a><a href="/index.html">Documentation</a><a href="/appsync/index.html">AWS AppSync</a><a href="what-is-appsync.html">Developer Guide</a></div><div id="page-toc-src"><a href="#overview">Overview</a><a href="#reading-data">Reading data</a><a href="#writing-data">Writing data</a><a href="#public-and-private-records">Public and private records</a><a href="#security-real-time-data">Real-time data</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="security-authorization-use-cases"><a id="aws-appsync-security-authorization-use-cases"></a>Authorization
            use cases</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>In the <a href="./security-authz.html#aws-appsync-security">Security</a> section you learned about the different
        Authorization modes for protecting your API and an introduction was given on Fine Grained Authorization
        mechanisms to understand the concepts and flow. Since AWS AppSync allows you to perform logic full operations on
        data through the use of GraphQL Resolver <a href="./resolver-mapping-template-reference-overview.html#aws-appsync-resolver-mapping-template-reference-overview">Mapping templates</a>, you can protect
        data on read or write in a very flexible manner using a combination of user identity, conditionals, and data
        injection.</p><p>If you’re not familiar with editing AWS AppSync Resolvers, review the <a href="./resolver-mapping-template-reference-programming-guide.html#aws-appsync-resolver-mapping-template-reference-programming-guide">programming
            guide</a>.</p>
        <h2 id="overview">Overview</h2>
        <p>Granting access to data in a system is traditionally done through an <a href="https://en.wikipedia.org/wiki/Access_Control_Matrix" rel="noopener noreferrer" target="_blank"><span>Access control matrix</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> where the
            intersection of a row (resource) and column (user/role) is the permissions granted.</p>
        <p>AWS AppSync uses resources in your own account and threads identity (user/role)
            information into the GraphQL request and response as a <a href="./resolver-context-reference.html#aws-appsync-resolver-mapping-template-context-reference">context
                object</a>, which you can use in the resolver. This means that permissions can be
            granted appropriately either on write or read operations based on the resolver logic. If
            this logic is at the resource level, for example only certain named users or groups can
            read/write to a specific database row, then that “authorization metadata” must be
            stored. AWS AppSync does not store any data so therefore you must store this authorization
            metadata with the resources so that permissions can be calculated. Authorization
            metadata is usually an attribute (column) in a DynamoDB table, such as an <b>owner</b> or list of users/groups. For example there could be
                <b>Readers</b> and <b>Writers</b> attributes.</p>
        <p>From a high level, what this means is that if you are reading an individual item from
            a data source, you perform a conditional <code class="code">#if () ... #end</code> statement in the
            response template after the resolver has read from the data source. The check will
            normally be using user or group values in <code class="code">$context.identity</code> for membership
            checks against the authorization metadata returned from a read operation. For multiple
            records, such as lists returned from a table <code class="code">Scan</code> or <code class="code">Query</code>,
            you’ll send the condition check as part of the operation to the data source using
            similar user or group values.</p>
        <p>Similarly when writing data you’ll apply a conditional statement to the action (like a
                <code class="code">PutItem</code> or <code class="code">UpdateItem</code> to see if the user or group making a
            mutation has permission. The conditional again will many times be using a value in
                <code class="code">$context.identity</code> to compare against authorization metadata on that
            resource. For both request and response templates you can also use custom headers from
            clients to perform validation checks.</p>
     
        <h2 id="reading-data">Reading data</h2>
        <p>As outlined above the authorization metadata to perform a check must be stored with a
            resource or passed in to the GraphQL request (identity, header, etc.). To demonstrate
            this suppose you have the DynamoDB table below:</p>
        <div class="mediaobject">
             
                <img src="/images/appsync/latest/devguide/images/auth.png" class="aws-docs-img-whiteBg aws-docs-img-padding" style="max-width:100%" />
             
        </div>
        <p>The primary key is <code class="code">id</code> and the data to be accessed is <code class="code">Data</code>. The other columns are
            examples of checks you can perform for authorization. <code class="code">Owner</code> would be a <code class="code">String</code>
            while <code class="code">PeopleCanAccess</code> and <code class="code">GroupsCanAccess</code> would be <code class="code">String Sets</code> as
            outlined in the <a href="./resolver-mapping-template-reference-dynamodb.html#aws-appsync-resolver-mapping-template-reference-dynamodb">Resolver mapping
                template reference for DynamoDB</a>.</p>
        <p>In the <a href="./resolver-mapping-template-reference-overview.html#aws-appsync-resolver-mapping-template-reference-overview">resolver mapping template overview</a> the diagram shows how the response
            template contains not only the context object but also the results from the data source.
            For GraphQL queries of individual items, you can use the response template to check if
            the user is allowed to see these results or return an authorization error message. This
            is sometimes referred to as an “Authorization filter”. For GraphQL queries returning
            lists, using a Scan or Query, it is more performant to perform the check on the request
            template and return data only if an authorization condition is satisfied. The
            implementation is then:</p>
        <div class="orderedlist">
             
             
        <ol><li>
                <p>GetItem - authorization check for individual records. Done using <code class="code">#if()
                        ... #end</code> statements.</p>
            </li><li>
                <p>Scan/Query operations - authorization check is a
                        <code class="code">"filter":<span>{</span>"expression":...}</code> statement. Common checks are
                    equality (<code class="code">attribute = :input</code>) or checking if a value is in a list
                        (<code class="code">contains(attribute, :input)</code>).</p>
            </li></ol></div>
        <p>In #2 the <code class="code">attribute</code> in both statements represents the column name of the
            record in a table, such as <code class="code">Owner</code> in our above example. You can alias this
            with a <code class="code">#</code> sign and use <code class="code">"expressionNames":<span>{</span>...}</code> but it’s not
            mandatory. The <code class="code">:input</code> is a reference to the value you’re comparing to the
            database attribute, which you will define in <code class="code">"expressionValues":<span>{</span>...}</code>.
            You’ll see these examples below.</p>
         
            <h3 id="use-case-owner-can-read">Use case: owner can read</h3>
            <p>Using the table above, if you only wanted to return data if <code class="code">Owner ==
                    Nadia</code> for an individual read operation (<code class="code">GetItem</code>) your
                template would look like:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">#if($context.result["Owner"] == $context.identity.username)
    $utils.toJson($context.result)
#else
    $utils.unauthorized()
#end</code></pre>
            <p>A couple things to mention here which will be re-used in the remaining sections.
                First, the check uses <code class="code">$context.identity.username</code> which will be the
                friendly user sign-up name if Amazon Cognito user pools is used and will be the user identity
                if IAM is used (including Amazon Cognito Federated Identities). There are other values to
                store for an owner such as the unique “Amazon Cognito identity” value, which is useful when
                federating logins from multiple locations, and you should review the options
                available in the <a href="./resolver-context-reference.html#aws-appsync-resolver-mapping-template-context-reference">Resolver
                    Mapping Template Context Reference</a>.</p>
            <p>Second, the conditional else check responding with
                    <code class="code">$util.unauthorized()</code> is completely optional but recommended as a
                best practice when designing your GraphQL API.</p>
         
         
            <h3 id="use-case-hardcode-specific-access">Use case: hardcode specific access</h3>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">// This checks if the user is part of the Admin group and makes the call
#foreach($group in $context.identity.claims.get("cognito:groups"))
    #if($group == "Admin")
        #set($inCognitoGroup = true)
    #end
#end
#if($inCognitoGroup)
<span>{</span>
    "version" : "2017-02-28",
    "operation" : "UpdateItem",
    "key" : <span>{</span>
        "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
    },
    "attributeValues" : <span>{</span>
        "owner" : $util.dynamodb.toDynamoDBJson($context.identity.username)
        #foreach( $entry in $context.arguments.entrySet() )
            ,"$<span>{</span>entry.key}" : $util.dynamodb.toDynamoDBJson($entry.value)
        #end
    }
}
#else
    $utils.unauthorized()
#end</code></pre>
         
         
            <h3 id="use-case-filtering-a-list-of-results">Use case: filtering a list of results</h3>
            <p>In the previous example you were able to perform a check against
                    <code class="code">$context.result</code> directly as it returned a single item, however some
                operations like a scan will return multiple items in
                    <code class="code">$context.result.items</code> where you need to perform the authorization
                filter and only return results that the user is allowed to see. Suppose the
                    <code class="code">Owner</code> field had the Amazon Cognito IdentityID this time set on the record,
                you could then use the following response mapping template to filter to only show
                those records that the user owned:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">#set($myResults = [])
#foreach($item in $context.result.items)
    ##For userpools use $context.identity.username instead
    #if($item.Owner == $context.identity.cognitoIdentityId)
        #set($added = $myResults.add($item))
    #end
#end
$utils.toJson($myResults)</code></pre>
         
         
            <h3 id="use-case-multiple-people-can-read">Use case: multiple people can read</h3>
            <p>Another popular authorization option is to allow a group of people to be able to
                read data. In the example below the <code class="code">"filter":<span>{</span>"expression":...}</code> only
                returns values from a table scan if the user running the GraphQL query is listed in
                the set for <code class="code">PeopleCanAccess</code>.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><span>{</span>
    "version" : "2017-02-28",
    "operation" : "Scan",
    "limit": #if($<span>{</span>context.arguments.count}) $util.toJson($context.arguments.count) #else 20 #end,
    "nextToken": #if($<span>{</span>context.arguments.nextToken})  $util.toJson($context.arguments.nextToken) #else null #end,
    "filter":<span>{</span>
        "expression": "contains(#peopleCanAccess, :value)",
        "expressionNames": <span>{</span>
                "#peopleCanAccess": "peopleCanAccess"
        },
        "expressionValues": <span>{</span>
                ":value": $util.dynamodb.toDynamoDBJson($context.identity.username)
        }
    }
}</code></pre>
         
         
            <h3 id="use-case-group-can-read">Use case: group can read</h3>
            <p>Similar to the last use case, it may be that only people in one or more groups
                have rights to read certain items in a database. Use of the <code class="code">"expression":
                    "contains()"</code> operation is similar however it’s a logical-OR of all the
                groups that a user might be a part of which needs to be accounted for in the set
                membership. In this case we build up a <code class="code">$expression</code> statement below for
                each group the user is in and then pass this to the filter:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">#set($expression = "")
#set($expressionValues = <span>{</span>})
#foreach($group in $context.identity.claims.get("cognito:groups"))
    #set( $expression = "$<span>{</span>expression} contains(groupsCanAccess, :var$foreach.count )" )
    #set( $val = <span>{</span>})
    #set( $test = $val.put("S", $group))
    #set( $values = $expressionValues.put(":var$foreach.count", $val))
    #if ( $foreach.hasNext )
    #set( $expression = "$<span>{</span>expression} OR" )
    #end
#end
<span>{</span>
    "version" : "2017-02-28",
    "operation" : "Scan",
    "limit": #if($<span>{</span>context.arguments.count}) $util.toJson($context.arguments.count) #else 20 #end,
    "nextToken": #if($<span>{</span>context.arguments.nextToken})  $util.toJson($context.arguments.nextToken) #else null #end,
    "filter":<span>{</span>
        "expression": "$expression",
        "expressionValues": $utils.toJson($expressionValues)
    }
}</code></pre>
         
     
        <h2 id="writing-data">Writing data</h2>
        <p>Writing data on mutations is always controlled on the request mapping template. In the
            case of DynamoDB data sources, the key is to use an appropriate
                <code class="code">"condition":<span>{</span>"expression"...}"</code> which performs validation against the
            authorization metadata in that table. In <a href="./security-authz.html#aws-appsync-security">Security</a>, we provided an example you can use to check the
                <code class="code">Author</code> field in a table. The use cases in this section explore more use
            cases.</p>
         
            <h3 id="use-case-multiple-owners">Use case: multiple owners</h3>
            <p>Using the example table diagram from earlier, suppose the
                    <code class="code">PeopleCanAccess</code> list</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><span>{</span>
    "version" : "2017-02-28",
    "operation" : "UpdateItem",
    "key" : <span>{</span>
        "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
    },
    "update" : <span>{</span>
        "expression" : "SET meta = :meta",
        "expressionValues": <span>{</span>
            ":meta" : $util.dynamodb.toDynamoDBJson($ctx.args.meta)
        }
    },
    "condition" : <span>{</span>
        "expression"       : "contains(Owner,:expectedOwner)",
        "expressionValues" : <span>{</span>
            ":expectedOwner" : $util.dynamodb.toDynamoDBJson($context.identity.username)
        }
    }
}</code></pre>
         
         
            <h3 id="use-case-group-can-create-new-record">Use case: group can create new record</h3>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">#set($expression = "")
#set($expressionValues = <span>{</span>})
#foreach($group in $context.identity.claims.get("cognito:groups"))
    #set( $expression = "$<span>{</span>expression} contains(groupsCanAccess, :var$foreach.count )" )
    #set( $val = <span>{</span>})
    #set( $test = $val.put("S", $group))
    #set( $values = $expressionValues.put(":var$foreach.count", $val))
    #if ( $foreach.hasNext )
    #set( $expression = "$<span>{</span>expression} OR" )
    #end
#end
<span>{</span>
    "version" : "2017-02-28",
    "operation" : "PutItem",
    "key" : <span>{</span>
        ## If your table's hash key is not named 'id', update it here. **
        "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
        ## If your table has a sort key, add it as an item here. **
    },
    "attributeValues" : <span>{</span>
        ## Add an item for each field you would like to store to Amazon DynamoDB. **
        "title" : $util.dynamodb.toDynamoDBJson($ctx.args.title),
        "content": $util.dynamodb.toDynamoDBJson($ctx.args.content),
        "owner": $util.dynamodb.toDynamoDBJson($context.identity.username)
    },
    "condition" : <span>{</span>
        "expression": $util.toJson("attribute_not_exists(id) AND $expression"),
        "expressionValues": $utils.toJson($expressionValues)
    }
}</code></pre>
         
         
            <h3 id="use-case-group-can-update-existing-record">Use case: group can update existing
                    record</h3>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">#set($expression = "")
#set($expressionValues = <span>{</span>})
#foreach($group in $context.identity.claims.get("cognito:groups"))
    #set( $expression = "$<span>{</span>expression} contains(groupsCanAccess, :var$foreach.count )" )
    #set( $val = <span>{</span>})
    #set( $test = $val.put("S", $group))
    #set( $values = $expressionValues.put(":var$foreach.count", $val))
    #if ( $foreach.hasNext )
    #set( $expression = "$<span>{</span>expression} OR" )
    #end
#end
<span>{</span>
    "version" : "2017-02-28",
    "operation" : "UpdateItem",
    "key" : <span>{</span>
        "id" : $util.dynamodb.toDynamoDBJson($ctx.args.id)
    },
    "update":<span>{</span>
                "expression" : "SET title = :title, content = :content",
        "expressionValues": <span>{</span>
            ":title" : $util.dynamodb.toDynamoDBJson($ctx.args.title),
            ":content" : $util.dynamodb.toDynamoDBJson($ctx.args.content)
        }
    },
    "condition" : <span>{</span>
        "expression": $util.toJson($expression),
        "expressionValues": $utils.toJson($expressionValues)
    }
}</code></pre>
         
     
        <h2 id="public-and-private-records">Public and private records</h2>
        <p>With the conditional filters you can also choose to mark data as private, public or
            some other Boolean check. This can then be combined as part of an authorization filter
            inside the response template. Using this check is a nice way to temporarily hide data or
            remove it from view without trying to control group membership.</p>
        <p>For example suppose you added an attribute on each item in your DynamoDB table called
                <code class="code">public</code> with either a value of <code class="code">yes</code> or <code class="code">no</code>. The
            following response template could be used on a <code class="code">GetItem</code> call to only display
            data if the user is in a group that has access AND if that data is marked as
            public:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">#set($permissions = $context.result.GroupsCanAccess)
#set($claimPermissions = $context.identity.claims.get("cognito:groups"))

#foreach($per in $permissions)
    #foreach($cgroups in $claimPermissions)
        #if($cgroups == $per)
            #set($hasPermission = true)
        #end
    #end
#end

#if($hasPermission &amp;&amp; $context.result.public == 'yes')
    $utils.toJson($context.result)
#else
    $utils.unauthorized()
#end</code></pre>
        <p>The above code could also use a logical OR (<code class="code">||</code>) to allow people to read
            if they have permission to a record or if it’s public:</p>
        <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">#if($hasPermission || $context.result.public == 'yes')
    $utils.toJson($context.result)
#else
    $utils.unauthorized()
#end</code></pre>
        <p>In general, you will find the standard operators <code class="code">==</code>, <code class="code">!=</code>,
                <code class="code">&amp;&amp;</code>, and <code class="code">||</code> helpful when performing authorization
            checks.</p>
     
        <h2 id="security-real-time-data">Real-time data</h2>
        <p>You can apply Fine Grained Access Controls to GraphQL subscriptions at the time a
            client makes a subscription, using the same techniques described earlier in this
            documentation. You attach a resolver to the subscription field, at which point you can
            query data from a data source and perform conditional logic in either the request or
            response mapping template. You can also return additional data to the client, such as
            the initial results from a subscription, as long as the data structure matches that of
            the returned type in your GraphQL subscription.</p>
         
            <h3 id="use-case-user-can-subscribe-to-specific-conversations-only">Use case: user can
                    subscribe to specific conversations only</h3>
            <p>A common use case for real-time data with GraphQL subscriptions is building a
                messaging or private chat application. When creating a chat application that has
                multiple users, conversations can occur between two people or among multiple people.
                These might be grouped into “rooms”, which are private or public. As such, you would
                only want to authorize a user to subscribe to a conversation (which could be one to
                one or among a group) for which they have been granted access. For demonstration
                purposes, the sample below shows a simple use case of one user sending a private
                message to another. The setup has two Amazon DynamoDB tables:</p>
            <div class="itemizedlist">
                 
                 
            <ul class="itemizedlist"><li class="listitem">
                    <p>Messages table: (primary key) <code class="code">toUser</code>, (sort key)
                            <code class="code">id</code>
                    </p>
                </li><li class="listitem">
                    <p>Permissions table: (primary key) <code class="code">username</code>
                    </p>
                </li></ul></div>
            <p>The Messages table stores the actual messages that get sent via a GraphQL
                mutation. The Permissions table is checked by the GraphQL subscription for
                authorization at client connection time. The example below assumes you are using the
                following GraphQL schema:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">input CreateUserPermissionsInput <span>{</span>
    user: String!
    isAuthorizedForSubscriptions: Boolean
}

type Message <span>{</span>
    id: ID
    toUser: String
    fromUser: String
    content: String
}

type MessageConnection <span>{</span>
    items: [Message]
    nextToken: String
}

type Mutation <span>{</span>
    sendMessage(toUser: String!, content: String!): Message
    createUserPermissions(input: CreateUserPermissionsInput!): UserPermissions
    updateUserPermissions(input: UpdateUserPermissionInput!): UserPermissions
}

type Query <span>{</span>
    getMyMessages(first: Int, after: String): MessageConnection
    getUserPermissions(user: String!): UserPermissions
}

type Subscription <span>{</span>
    newMessage(toUser: String!): Message
        @aws_subscribe(mutations: ["sendMessage"])
}

input UpdateUserPermissionInput <span>{</span>
    user: String!
    isAuthorizedForSubscriptions: Boolean
}

type UserPermissions <span>{</span>
    user: String
    isAuthorizedForSubscriptions: Boolean
}

schema <span>{</span>
    query: Query
    mutation: Mutation
    subscription: Subscription
}</code></pre>
            <p>Some of the standard operations, such as <code class="code">createUserPermissions()</code>, are
                not covered below to illustrate the subscription resolvers, but are standard
                implementations of DynamoDB resolvers. Instead, we’ll focus on subscription
                authorization flows with resolvers. To send a message from one user to another,
                attach a resolver to the <code class="code">sendMessage()</code> field and select the <b>Messages</b> table data source with the following request
                template:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><span>{</span>
    "version" : "2017-02-28",
    "operation" : "PutItem",
    "key" : <span>{</span>
        "toUser" : $util.dynamodb.toDynamoDBJson($ctx.args.toUser),
        "id" : $util.dynamodb.toDynamoDBJson($util.autoId())
    },
    "attributeValues" : <span>{</span>
        "fromUser" : $util.dynamodb.toDynamoDBJson($context.identity.username),
        "content" : $util.dynamodb.toDynamoDBJson($ctx.args.content),
    }
}</code></pre>
            <p>In this example, we use <code class="code">$context.identity.username</code>. This returns user
                information for AWS Identity and Access Management or Amazon Cognito users. The response template is a simple
                passthrough of <code class="code">$util.toJson($ctx.result)</code>. Save and go back to the
                schema page. Then attach a resolver for the <code class="code">newMessage()</code> subscription,
                using the <b>Permissions</b> table as a data source and
                the following request mapping template:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight"><span>{</span>
    "version": "2018-05-29",
    "operation": "GetItem",
    "key": <span>{</span>
        "username": $util.dynamodb.toDynamoDBJson($ctx.identity.username),
    },
}</code></pre>
            <p>Then use the following response mapping template to perform your authorization
                checks using data from the <b>Permissions</b>
                table:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">#if(! $<span>{</span>context.result})
    $utils.unauthorized()
#elseif($<span>{</span>context.identity.username} != $<span>{</span>context.arguments.toUser})
    $utils.unauthorized()
#elseif(! $<span>{</span>context.result.isAuthorizedForSubscriptions})
    $utils.unauthorized()
#else
##User is authorized, but we return null to continue
    null
#end</code></pre>
            <p>In this case, you’re doing three authorization checks. The first ensures that a
                result is returned. The second ensures that the user isn’t subscribing to messages
                that are meant for another person. The third ensures that the user is allowed to
                subscribe to any fields, by checking a DynamoDB attribute of
                    <code class="code">isAuthorizedForSubscriptions</code> stored as a <code class="code">BOOL</code>.</p>
            <p>To test things out, you could sign in to the AWS AppSync console using Amazon Cognito user
                pools and a user named “Nadia”, and then run the following GraphQL
                subscription:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><code class="nohighlight">subscription AuthorizedSubscription <span>{</span>
    newMessage(toUser: "Nadia") <span>{</span>
        id
        toUser
        fromUser
        content
    }
}</code></pre>
            <p>If in the <b>Permissions</b> table there is a record for
                the <code class="code">username</code> key attribute of <code class="code">Nadia</code> with
                    <code class="code">isAuthorizedForSubscriptions</code> set to <code class="code">true</code>, you’ll see a
                successful response. If you try a different <code class="code">username</code> in the
                    <code class="code">newMessage()</code> query above, an error will be returned.</p>
         
    <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./security-authz.html">Authorization and
         authentication</div><div id="next" class="next-link" accesskey="n" href="./WAF-Integration.html">Using AWS WAF to protect APIs</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=AppSync&amp;topic_url=https://docs.aws.amazon.com/en_us/appsync/latest/devguide/security-authorization-use-cases.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=AppSync&amp;topic_url=https://docs.aws.amazon.com/en_us/appsync/latest/devguide/security-authorization-use-cases.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>